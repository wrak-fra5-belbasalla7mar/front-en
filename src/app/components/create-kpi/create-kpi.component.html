<div class="container mt-4">
  <h2 class="mb-4">Create New KPI</h2>

  <!-- Error & Success Alerts -->
  <div class="alert alert-danger" *ngIf="errorMessage">{{ errorMessage }}</div>
  <div class="alert alert-success" *ngIf="successMessage">{{ successMessage }}</div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form>
        <!-- KPI Name -->
        <div class="mb-3">
          <label for="kpiName" class="form-label">KPI Name</label>
          <input type="text" id="kpiName" class="form-control" [(ngModel)]="newKPI.name" name="kpiName" required />
        </div>

        <!-- Select Cycle -->
        <div class="mb-3">
          <label for="cycleSelect" class="form-label">Select Cycle</label>
          <select id="cycleSelect" class="form-select" [(ngModel)]="selectedCycleId" name="cycleSelect" required>
            <option value="" disabled>Select a cycle</option>
            <option *ngFor="let cycle of cycles" [value]="cycle.id">
              {{ cycle.name }} ({{ cycle.startDate }} - {{ cycle.endDate }})
            </option>
          </select>
        </div>

        <!-- Assign Roles -->
        <div class="mb-3">
          <label class="form-label">Assign Roles (Optional)</label>
          <div *ngFor="let roleAssignment of selectedRoles; let i = index" class="mb-2">
            <div class="row">
              <!-- Select Role -->
              <div class="col-md-5">
                <select class="form-select" [(ngModel)]="roleAssignment.role" [ngModelOptions]="{standalone: true}">
                  <option [ngValue]="null" disabled>Select a role</option>
                  <option *ngFor="let role of allRoles" [ngValue]="role">
                    {{ role.name }} ({{ role.level }})
                  </option>
                </select>
              </div>

              <!-- Role Weight -->
              <div class="col-md-3">
                <input type="number" class="form-control" placeholder="Weight" [(ngModel)]="roleAssignment.weight"
                  [ngModelOptions]="{standalone: true}" min="0" step="0.1" />
              </div>

              <!-- Remove Button -->
              <div class="col-md-4">
                <button type="button" class="btn btn-danger btn-sm" (click)="removeRole(i)">Remove</button>
              </div>
            </div>
          </div>

          <!-- Add Role Button -->
          <button type="button" class="btn btn-outline-secondary btn-sm mt-2" (click)="addRole()">Add Role</button>
        </div>

        <!-- Add New Role Form -->
        <div *ngIf="showAddRoleForm" class="card p-3 mt-3 bg-light">
          <h6>Create New Role</h6>
          <div class="mb-2">
            <input type="text" class="form-control" placeholder="Role Name" [(ngModel)]="newRole.name"
              [ngModelOptions]="{standalone: true}" />
          </div>
          <div class="mb-2">
            <select class="form-select" [(ngModel)]="newRole.level" [ngModelOptions]="{standalone: true}">
              <option [ngValue]="null" disabled>Select Level</option>
              <option *ngFor="let level of levelOptions" [ngValue]="level">{{ level }}</option>
            </select>
          </div>
          <div>
            <button type="button" class="btn btn-success btn-sm me-2" (click)="saveNewRole()">Save</button>
            <button type="button" class="btn btn-secondary btn-sm" (click)="cancelAddRole()">Cancel</button>
          </div>
        </div>

        <!-- Show Add Role Form -->
        <button type="button" class="btn btn-link mt-3" (click)="showAddRole()">+ Create New Role</button>

        <!-- Submit Button -->
        <div class="mt-3">
          <button type="button" class="btn btn-primary" (click)="createKPI()" [disabled]="isLoading">
            {{ isLoading ? 'Creating...' : 'Create KPI' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
