<div class="container mt-4">
  <h2 class="mb-4">Evaluation</h2>

  <!-- Alert Messages -->
  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <!-- Passed Cycle Evaluation -->
  <div *ngIf="passedCycle" class="mb-5">
    <h4>
      {{ passedCycle.name }} ({{ passedCycle.startDate }} - {{ passedCycle.endDate }})
      <span class="badge bg-success">{{ passedCycle.state }}</span>
    </h4>

    <!-- Team Members to Evaluate -->
    <div *ngIf="teamMembers.length > 0 && !showEvaluationForm">
      <h5 class="mt-3">Evaluate Your Team</h5>
      <ul class="list-group">
        <li *ngFor="let member of teamMembers" class="list-group-item d-flex justify-content-between align-items-center">
          {{ member.name }}
          <button class="btn btn-primary btn-sm" (click)="startEvaluation(member)">
            Evaluate
          </button>
        </li>
      </ul>
    </div>

    <!-- No Members -->
    <div *ngIf="teamMembers.length === 0 && !showEvaluationForm" class="text-muted">
      No team members available to evaluate.
    </div>
  </div>

  <!-- Evaluation Form -->
  <div *ngIf="showEvaluationForm" class="card mb-4">
    <div class="card-body">
      <h5 class="mb-3">Evaluating: {{ selectedMember?.name }}</h5>
      <form (ngSubmit)="saveEvaluation()">
        <div *ngFor="let evalKpi of evaluationKpis; let i = index" class="mb-4">
          <label class="form-label fw-bold">{{ evalKpi.kpi.name }}</label>
          <div class="row g-2 align-items-center">
            <div class="col-md-2">
              <input
                type="number"
                class="form-control"
                [(ngModel)]="evalKpi.score"
                name="score{{ i }}"
                min="1"
                max="5"
                required
              />
            </div>
            <div class="col-md-10">
              <textarea
                class="form-control"
                [(ngModel)]="evalKpi.feedback"
                name="feedback{{ i }}"
                placeholder="Enter feedback"
              ></textarea>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-success me-2" [disabled]="isLoading">
          {{ isLoading ? 'Saving...' : 'Save Evaluation' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelEvaluation()" [disabled]="isLoading">
          Cancel
        </button>
      </form>
    </div>
  </div>

  <!-- Other Cycles Viewer -->
  <div *ngIf="otherCycles.length > 0">
    <h4>Other Cycles</h4>
    <div class="row">
      <div *ngFor="let cycle of otherCycles" class="col-md-4 mb-3">
        <div class="card h-100" (click)="selectOtherCycle(cycle)" style="cursor: pointer;">
          <div class="card-body">
            <h5 class="card-title">{{ cycle.name }}</h5>
            <p class="card-text">
              <strong>Duration:</strong><br>
              {{ cycle.startDate }} - {{ cycle.endDate }}<br>
              <strong>Status:</strong>
              <span class="badge"
                [ngClass]="{
                  'bg-warning': cycle.state === 'OPEN',
                  'bg-danger': cycle.state === 'CLOSED'
                }"
              >
                {{ cycle.state }}
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Team Members in Selected Cycle -->
  <div *ngIf="selectedOtherCycle && !showEvaluationForm" class="mt-4">
    <h5>
      Team Members in {{ selectedOtherCycle.name }}
    </h5>
    <ul class="list-group">
      <li *ngFor="let member of teamMembers" class="list-group-item">
        {{ member.name }}
      </li>
    </ul>
  </div>

  <!-- No Cycles -->
  <div *ngIf="!passedCycle && otherCycles.length === 0 && !errorMessage" class="text-muted">
    No cycles available.
  </div>
</div>
