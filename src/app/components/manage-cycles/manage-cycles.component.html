<div class="container mt-4">
  <h2>Manage Cycles</h2>

  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

  <!-- Show Create New Cycle form only for COMPANY_MANAGER -->
  <div *ngIf="isCompanyManager()" class="card mb-4">
    <div class="card-header">Create New Cycle</div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Cycle Name</label>
        <input type="text" class="form-control" [(ngModel)]="newCycle.name" />
      </div>

      <div class="row">
        <div class="col-md-6">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-control" [(ngModel)]="newCycle.startDate" />
        </div>
        <div class="col-md-6">
          <label class="form-label">End Date</label>
          <input type="date" class="form-control" [(ngModel)]="newCycle.endDate" />
        </div>
      </div>

      <div class="mt-4">
        <h5>Assign KPIs to this Cycle</h5>
        <div *ngFor="let kpi of allKPIs">
          <input
            type="checkbox"
            [id]="'kpi-' + kpi.id"
            [value]="kpi.id"
            (change)="onKpiChange($event, kpi.id!)"
          />
          <label [for]="'kpi-' + kpi.id">{{ kpi.name }}</label>
        </div>

        <button type="button" class="btn btn-link" (click)="toggleKpiForm()">
          + Create New KPI
        </button>

        <div *ngIf="showKpiForm" class="border p-3 mt-3 bg-light">
          <h6>Create KPI</h6>
          <div class="mb-2">
            <label class="form-label">KPI Name</label>
            <input type="text" class="form-control" [(ngModel)]="newKpi.name" />
          </div>

          <h6>Assign to Roles</h6>
          <div *ngFor="let roleEntry of selectedRoles; let i = index" class="row mb-2">
            <div class="col-md-5">
              <select class="form-select" [(ngModel)]="roleEntry.role">
                <option [ngValue]="null">Select Role</option>
                <option *ngFor="let role of allRoles" [ngValue]="role">
                  {{ role.name }} ({{ role.level }})
                </option>
              </select>
            </div>
            <div class="col-md-3">
              <input
                type="number"
                class="form-control"
                [(ngModel)]="roleEntry.weight"
                min="0.1"
                step="0.1"
              />
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-danger btn-sm" (click)="removeRoleEntry(i)">
                Remove
              </button>
            </div>
          </div>

          <button class="btn btn-outline-primary btn-sm" (click)="addRoleEntry()">+ Add Role</button>
          <button class="btn btn-outline-secondary btn-sm ms-2" (click)="toggleAddRoleForm()">+ Create Role</button>

          <div *ngIf="showAddRoleForm" class="border p-2 mt-3">
            <h6>Create Role</h6>
            <div class="mb-2">
              <input
                type="text"
                class="form-control"
                [(ngModel)]="newRole.name"
                placeholder="Role Name"
              />
            </div>
            <div class="mb-2">
              <select class="form-select" [(ngModel)]="newRole.level">
                <option [ngValue]="null" disabled>Select Level</option>
                <option *ngFor="let level of levelOptions" [ngValue]="level">
                  {{ level }}
                </option>
              </select>
            </div>
            <button class="btn btn-success btn-sm" (click)="createRole()">Save Role</button>
          </div>

          <button class="btn btn-success mt-3" (click)="createKpiAndAssign()">Save KPI</button>
        </div>
      </div>

      <div class="mt-4">
        <button class="btn btn-primary" (click)="createCycle()" [disabled]="loadingStates[newCycle.id!]">
          {{ loadingStates[newCycle.id!] ? 'Creating...' : 'Create Cycle' }}
        </button>
      </div>
    </div>
  </div>

  <div class="row" *ngIf="cycles.length > 0">
    <div class="col-md-4 mb-4" *ngFor="let cycle of cycles">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>{{ cycle.name }}</h5>
          <p>{{ cycle.startDate }} - {{ cycle.endDate }}</p>
          <p>Status: <span class="badge bg-info">{{ cycle.state }}</span></p>
         
          <div class="mt-2">
            <!-- Add Objectives Button for OPEN Cycles -->
            <button
              *ngIf="isTeamManager() && cycle.state === 'OPEN'"
              class="btn btn-primary btn-sm me-2"
              [routerLink]="['/add-objectives', currentUser?.id, cycle.id]"
              [disabled]="loadingStates[cycle.id!]"
            >
              Add Objectives
            </button>
            <!-- Download Report Button for CLOSED Cycles -->
            <button
              *ngIf="isCompanyManager() && cycle.state === 'CLOSED'"
              class="btn btn-primary btn-sm"
              (click)="downloadReport(cycle.id!)"
              [disabled]="loadingStates[cycle.id!]"
            >
              {{ loadingStates[cycle.id!] ? 'Downloading...' : 'Download Report' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>